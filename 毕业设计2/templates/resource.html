{% extends "base.html" %}

{% block title %}资源分析 - 生产效率分析系统{% endblock %}

{% block page_title %}资源分析{% endblock %}

{% block content %}
<div class="data-filters">
    <div class="row">
        <div class="col-md-6">
            <label for="dateRange" class="form-label">选择日期范围</label>
            <input type="text" class="form-control" id="dateRange">
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-6">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">设备利用率分布</h5>
                <div class="chart-container">
                    <canvas id="equipmentUtilizationChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">环境指标趋势</h5>
                <div class="chart-container">
                    <canvas id="environmentTrendChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">资源使用详情</h5>
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>设备ID</th>
                                <th>运行状态</th>
                                <th>平均温度(°C)</th>
                                <th>平均湿度(%)</th>
                                <th>平均PM2.5</th>
                            </tr>
                        </thead>
                        <tbody id="resourceTable">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let equipmentUtilizationChart, environmentTrendChart;

// 初始化日期选择器
$(document).ready(function() {
    initDateRangePicker(function(start, end) {
        updateResourceAnalysis(start.format('YYYY-MM-DD'), end.format('YYYY-MM-DD'));
    });
    // 初始加载数据
    const start = moment().subtract(7, 'days');
    const end = moment();
    updateResourceAnalysis(start.format('YYYY-MM-DD'), end.format('YYYY-MM-DD'));
});

async function updateResourceAnalysis(start_time, end_time) {
    const data = await fetchAnalysisData('resource-analysis', {
        start_time: start_time,
        end_time: end_time
    });
    
    if (data) {
        updateEquipmentUtilizationChart(data);
        updateEnvironmentTrendChart(data);
        updateResourceTable(data);
    }
}

function updateEquipmentUtilizationChart(data) {
    if (equipmentUtilizationChart) equipmentUtilizationChart.destroy();
    
    const devices = Object.keys(data.equipment_utilization);
    const statuses = Object.keys(data.equipment_utilization[devices[0]] || {});
    const datasets = statuses.map(status => ({
        label: status,
        data: devices.map(device => data.equipment_utilization[device][status] || 0),
        backgroundColor: getRandomColor()
    }));
    
    equipmentUtilizationChart = new Chart(document.getElementById('equipmentUtilizationChart'), {
        type: 'bar',
        data: {
            labels: devices,
            datasets: datasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: { stacked: true },
                y: { stacked: true }
            },
            plugins: {
                title: {
                    display: true,
                    text: '设备状态分布'
                }
            }
        }
    });
}

function updateEnvironmentTrendChart(data) {
    if (environmentTrendChart) environmentTrendChart.destroy();
    
    const metrics = data.environment_metrics;
    environmentTrendChart = new Chart(document.getElementById('environmentTrendChart'), {
        type: 'line',
        data: {
            labels: ['温度', '湿度', 'PM2.5'],
            datasets: [{
                label: '环境指标',
                data: [
                    metrics.avg_temperature,
                    metrics.avg_humidity,
                    metrics.avg_pm25
                ],
                borderColor: 'rgba(75, 192, 192, 1)',
                fill: false
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: '环境指标分析'
                }
            }
        }
    });
}

function updateResourceTable(data) {
    const tableBody = document.getElementById('resourceTable');
    tableBody.innerHTML = '';
    
    Object.entries(data.equipment_utilization).forEach(([deviceId, status]) => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${deviceId}</td>
            <td>${Object.entries(status).map(([k, v]) => `${k}: ${v}%`).join(', ')}</td>
            <td>${data.environment_metrics.avg_temperature.toFixed(1)}</td>
            <td>${data.environment_metrics.avg_humidity.toFixed(1)}</td>
            <td>${data.environment_metrics.avg_pm25.toFixed(1)}</td>
        `;
        tableBody.appendChild(row);
    });
}

function getRandomColor() {
    const letters = '0123456789ABCDEF';
    let color = '#';
    for (let i = 0; i < 6; i++) {
        color += letters[Math.floor(Math.random() * 16)];
    }
    return color + '80'; // 添加50%透明度
}
</script>
{% endblock %} 