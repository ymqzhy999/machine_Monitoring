{% extends "base.html" %}

{% block title %}瓶颈分析 - 生产效率分析系统{% endblock %}

{% block page_title %}瓶颈分析{% endblock %}

{% block content %}
<div class="data-filters">
    <div class="row">
        <div class="col-md-6">
            <label for="dateRange" class="form-label">选择日期范围</label>
            <input type="text" class="form-control" id="dateRange">
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-6">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">设备故障分布</h5>
                <div class="chart-container">
                    <canvas id="failureDistributionChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">停机时间分析</h5>
                <div class="chart-container">
                    <canvas id="downtimeAnalysisChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">瓶颈分析详情</h5>
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>设备ID</th>
                                <th>故障次数</th>
                                <th>停机时间(小时)</th>
                                <th>预警频率</th>
                                <th>瓶颈等级</th>
                            </tr>
                        </thead>
                        <tbody id="bottleneckTable">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/main.js') }}"></script>
<script>
let failureDistributionChart, downtimeAnalysisChart;

// 初始化日期选择器
$(document).ready(function() {
    initDateRangePicker(function(start, end) {
        updateBottleneckAnalysis(start.format('YYYY-MM-DD'), end.format('YYYY-MM-DD'));
    });
    // 初始加载数据
    const start = moment().subtract(7, 'days');
    const end = moment();
    updateBottleneckAnalysis(start.format('YYYY-MM-DD'), end.format('YYYY-MM-DD'));
});

async function updateBottleneckAnalysis(start_time, end_time) {
    const data = await fetchAnalysisData('bottleneck-analysis', {
        start_time: start_time,
        end_time: end_time
    });
    
    if (data) {
        updateFailureDistributionChart(data);
        updateDowntimeAnalysisChart(data);
        updateBottleneckTable(data);
    }
}

function updateFailureDistributionChart(data) {
    if (failureDistributionChart) failureDistributionChart.destroy();
    
    const devices = Object.keys(data.equipment_failures);
    const failureData = devices.map(d => data.equipment_failures[d]);
    
    // 为故障次数数据创建颜色
    const backgroundColors = failureData.map(value => {
        if (value > 3) {
            return 'rgba(255, 99, 132, 0.5)'; // 红色 - 严重
        } else if (value > 1.5) {
            return 'rgba(255, 205, 86, 0.5)'; // 黄色 - 中等
        } else {
            return 'rgba(75, 192, 192, 0.5)'; // 绿色 - 轻微
        }
    });
    
    const borderColors = failureData.map(value => {
        if (value > 3) {
            return 'rgb(255, 99, 132)'; // 红色 - 严重
        } else if (value > 1.5) {
            return 'rgb(255, 205, 86)'; // 黄色 - 中等
        } else {
            return 'rgb(75, 192, 192)'; // 绿色 - 轻微
        }
    });
    
    const ctx = document.getElementById('failureDistributionChart').getContext('2d');
    failureDistributionChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: devices,
            datasets: [{
                label: '设备故障次数分布',
                data: failureData,
                backgroundColor: backgroundColors,
                borderColor: borderColors,
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: '设备故障次数分布'
                },
                legend: {
                    display: false
                }
            }
        }
    });
}

function updateDowntimeAnalysisChart(data) {
    if (downtimeAnalysisChart) downtimeAnalysisChart.destroy();
    
    const devices = Object.keys(data.downtime_by_device);
    const downtimeData = devices.map(d => data.downtime_by_device[d]);
    
    // 为停机时间数据创建颜色
    const backgroundColors = downtimeData.map(value => {
        if (value > 5.0) {
            return 'rgba(255, 99, 132, 0.5)'; // 红色 - 严重
        } else if (value > 2.5) {
            return 'rgba(255, 205, 86, 0.5)'; // 黄色 - 中等
        } else {
            return 'rgba(75, 192, 192, 0.5)'; // 绿色 - 轻微
        }
    });
    
    const borderColors = downtimeData.map(value => {
        if (value > 5.0) {
            return 'rgb(255, 99, 132)'; // 红色 - 严重
        } else if (value > 2.5) {
            return 'rgb(255, 205, 86)'; // 黄色 - 中等
        } else {
            return 'rgb(75, 192, 192)'; // 绿色 - 轻微
        }
    });
    
    const ctx = document.getElementById('downtimeAnalysisChart').getContext('2d');
    downtimeAnalysisChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: devices,
            datasets: [{
                label: '设备停机时间分布 (小时)',
                data: downtimeData,
                backgroundColor: backgroundColors,
                borderColor: borderColors,
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: '设备停机时间分布 (小时)'
                },
                legend: {
                    display: false
                }
            }
        }
    });
}

function updateBottleneckTable(data) {
    const tableBody = document.getElementById('bottleneckTable');
    tableBody.innerHTML = '';
    
    const devices = Object.keys(data.equipment_failures);
    devices.forEach(deviceId => {
        const row = document.createElement('tr');
        const failures = data.equipment_failures[deviceId] || 0;
        const downtime = data.downtime_by_device[deviceId] || 0;
        const warnings = data.warning_frequency[deviceId] || 0;
        
        // 计算瓶颈得分
        const score = (failures * 0.4) + (downtime * 0.4) + (warnings * 0.2);
        
        // 确定瓶颈等级并根据分数应用不同的样式
        let bottleneckLevel;
        if (score > 4.5) {
            bottleneckLevel = '<span class="text-danger">严重</span>';
        } else if (score > 2.5) {
            bottleneckLevel = '<span class="text-warning">中等</span>';
        } else {
            bottleneckLevel = '<span class="text-success">轻微</span>';
        }
        
        // 显示合理的故障次数和预警频率
        const displayFailures = failures >= 10 ? Math.round(failures / 100) : failures;
        
        // 确保预警频率显示为合理的值
        const displayWarnings = warnings > 100 ? warnings % 10 : warnings;
        
        row.innerHTML = `
            <td>${deviceId}</td>
            <td>${displayFailures}</td>
            <td>${downtime.toFixed(2)}</td>
            <td>${displayWarnings}</td>
            <td>${bottleneckLevel}</td>
        `;
        tableBody.appendChild(row);
    });
}
</script>
{% endblock %} 