{% extends "base.html" %}

{% block title %}人员效能分析 - 生产效率分析系统{% endblock %}

{% block page_title %}人员效能分析{% endblock %}

{% block content %}
<div class="data-filters">
    <div class="row">
        <div class="col-md-6">
            <label for="dateRange" class="form-label">选择日期范围</label>
            <input type="text" class="form-control" id="dateRange">
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-6">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">人员效能评分</h5>
                <div class="chart-container">
                    <canvas id="staffEfficiencyChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">人员技能雷达图</h5>
                <div>
                    <select class="form-select mb-3" id="staffSelect">
                        <option value="">请选择人员</option>
                    </select>
                </div>
                <div class="chart-container">
                    <canvas id="skillRadarChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">人员效能指标详情</h5>
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>工号</th>
                                <th>平均操作时长(小时)</th>
                                <th>熟练度(%)</th>
                                <th>成功率(%)</th>
                                <th>效能评分</th>
                            </tr>
                        </thead>
                        <tbody id="staffTable">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">团队效能总览</h5>
                <div class="row">
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h6 class="card-subtitle mb-2 text-muted">平均操作时长</h6>
                                <h3 id="teamAvgDuration">--</h3>
                                <p class="card-text text-muted">小时</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h6 class="card-subtitle mb-2 text-muted">平均熟练度</h6>
                                <h3 id="teamAvgSkill">--%</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h6 class="card-subtitle mb-2 text-muted">操作成功率</h6>
                                <h3 id="teamSuccessRate">--%</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h6 class="card-subtitle mb-2 text-muted">团队效能评分</h6>
                                <h3 id="teamEfficiencyScore">--</h3>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 新增：人员效能分析报告 -->
<div class="row mt-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">人员效能分析报告</h5>
                <div class="alert alert-info">
                    <h6><i class="bi bi-info-circle"></i> 分析方法</h6>
                    <p>本分析基于3西格玛原则（标准差）评估人员效能表现。通过计算团队效能指标的平均值和标准差，确定表现异常的员工，并提供相应的预警和预测。</p>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="card mb-3">
                            <div class="card-header bg-light">
                                <h6 class="mb-0">效能表现分析</h6>
                            </div>
                            <div class="card-body">
                                <div id="performanceAnalysis">
                                    <div class="d-flex justify-content-center">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">加载中...</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card mb-3">
                            <div class="card-header bg-light">
                                <h6 class="mb-0">预警与预测</h6>
                            </div>
                            <div class="card-body">
                                <div id="warningPrediction">
                                    <div class="d-flex justify-content-center">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">加载中...</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-header bg-light">
                                <h6 class="mb-0">3西格玛统计分布</h6>
                            </div>
                            <div class="card-body">
                                <div class="chart-container" style="height: 200px;">
                                    <canvas id="sigmaDistributionChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let staffEfficiencyChart, skillRadarChart, sigmaDistributionChart;
let staffData = {};

// 初始化日期选择器
$(document).ready(function() {
    initDateRangePicker(function(start, end) {
        loadStaffEfficiencyData(start.format('YYYY-MM-DD'), end.format('YYYY-MM-DD'));
    });
    
    // 初始加载数据
    const start = moment().subtract(7, 'days');
    const end = moment();
    loadStaffEfficiencyData(start.format('YYYY-MM-DD'), end.format('YYYY-MM-DD'));
    
    // 监听员工选择变化
    $('#staffSelect').change(function() {
        updateSkillRadarChart();
    });
});

async function loadStaffEfficiencyData(start_time, end_time) {
    const data = await fetchAnalysisData('staff-efficiency', {
        start_time: start_time,
        end_time: end_time
    });
    
    if (data) {
        staffData = data;
        updateStaffEfficiencyChart();
        updateStaffTable();
        updateTeamMetrics();
        updateStaffSelect();
        updateSkillRadarChart();
        generatePerformanceAnalysis();
        generateWarningPrediction();
        updateSigmaDistributionChart();
    }
}

function updateStaffEfficiencyChart() {
    const staffMetrics = staffData.staff_metrics || {};
    const staffIds = Object.keys(staffMetrics);
    const efficiencyScores = staffIds.map(id => staffMetrics[id].efficiency_score);
    
    if (staffEfficiencyChart) staffEfficiencyChart.destroy();
    
    staffEfficiencyChart = new Chart(document.getElementById('staffEfficiencyChart'), {
        type: 'bar',
        data: {
            labels: staffIds,
            datasets: [{
                label: '效能评分',
                data: efficiencyScores,
                backgroundColor: 'rgba(54, 162, 235, 0.5)',
                borderColor: 'rgba(54, 162, 235, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100,
                    title: {
                        display: true,
                        text: '效能评分'
                    }
                }
            },
            plugins: {
                title: {
                    display: true,
                    text: '人员效能评分对比'
                }
            }
        }
    });
}

function updateStaffTable() {
    const staffMetrics = staffData.staff_metrics || {};
    const tableBody = document.getElementById('staffTable');
    tableBody.innerHTML = '';
    
    Object.entries(staffMetrics).forEach(([staffId, metrics]) => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${staffId}</td>
            <td>${metrics.avg_operation_duration.toFixed(2)}</td>
            <td>${metrics.skill_level.toFixed(2)}</td>
            <td>${metrics.success_rate.toFixed(2)}</td>
            <td>${metrics.efficiency_score.toFixed(2)}</td>
        `;
        tableBody.appendChild(row);
    });
}

function updateTeamMetrics() {
    const teamMetrics = staffData.team_metrics || {};
    
    document.getElementById('teamAvgDuration').textContent = teamMetrics.avg_operation_duration ? teamMetrics.avg_operation_duration.toFixed(2) : '--';
    document.getElementById('teamAvgSkill').textContent = teamMetrics.avg_skill_level ? teamMetrics.avg_skill_level.toFixed(2) + '%' : '--%';
    document.getElementById('teamSuccessRate').textContent = teamMetrics.success_rate ? teamMetrics.success_rate.toFixed(2) + '%' : '--%';
    document.getElementById('teamEfficiencyScore').textContent = teamMetrics.efficiency_score ? teamMetrics.efficiency_score.toFixed(2) : '--';
}

function updateStaffSelect() {
    const staffMetrics = staffData.staff_metrics || {};
    const staffIds = Object.keys(staffMetrics);
    const selectElement = document.getElementById('staffSelect');
    
    // 清除现有选项
    selectElement.innerHTML = '<option value="">请选择人员</option>';
    
    // 添加人员选项
    staffIds.forEach(staffId => {
        const option = document.createElement('option');
        option.value = staffId;
        option.textContent = staffId;
        selectElement.appendChild(option);
    });
    
    // 如果有数据，默认选中第一个人员
    if (staffIds.length > 0) {
        selectElement.value = staffIds[0];
    }
}

function updateSkillRadarChart() {
    const selectedStaffId = document.getElementById('staffSelect').value;
    if (!selectedStaffId) return;
    
    const staffMetrics = staffData.staff_metrics || {};
    const skillDimensions = staffMetrics[selectedStaffId]?.skill_dimensions || {};
    
    const labels = Object.keys(skillDimensions);
    const values = labels.map(label => skillDimensions[label]);
    
    if (skillRadarChart) skillRadarChart.destroy();
    
    skillRadarChart = new Chart(document.getElementById('skillRadarChart'), {
        type: 'radar',
        data: {
            labels: labels,
            datasets: [{
                label: selectedStaffId,
                data: values,
                backgroundColor: 'rgba(54, 162, 235, 0.2)',
                borderColor: 'rgba(54, 162, 235, 1)',
                borderWidth: 2,
                pointBackgroundColor: 'rgba(54, 162, 235, 1)',
                pointBorderColor: '#fff',
                pointHoverBackgroundColor: '#fff',
                pointHoverBorderColor: 'rgba(54, 162, 235, 1)'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                r: {
                    angleLines: {
                        display: true
                    },
                    suggestedMin: 0,
                    suggestedMax: 100
                }
            },
            plugins: {
                title: {
                    display: true,
                    text: '技能雷达图'
                }
            }
        }
    });
}

// 新增：计算平均值
function calculateAverage(values) {
    if (!values || values.length === 0) return 0;
    return values.reduce((sum, val) => sum + val, 0) / values.length;
}

// 新增：计算标准差
function calculateStandardDeviation(values, mean) {
    if (!values || values.length <= 1) return 0;
    mean = mean || calculateAverage(values);
    const variance = values.reduce((sum, val) => sum + Math.pow(val - mean, 2), 0) / values.length;
    return Math.sqrt(variance);
}

// 新增：生成表现分析报告
function generatePerformanceAnalysis() {
    const staffMetrics = staffData.staff_metrics || {};
    const staffIds = Object.keys(staffMetrics);
    
    if (staffIds.length === 0) {
        document.getElementById('performanceAnalysis').innerHTML = '<p class="text-muted">暂无数据</p>';
        return;
    }
    
    // 提取所有效能评分
    const efficiencyScores = staffIds.map(id => staffMetrics[id].efficiency_score);
    const avgScore = calculateAverage(efficiencyScores);
    const stdDev = calculateStandardDeviation(efficiencyScores, avgScore);
    
    // 找出表现最好和最差的员工
    let bestStaffId = staffIds[0];
    let worstStaffId = staffIds[0];
    
    staffIds.forEach(id => {
        if (staffMetrics[id].efficiency_score > staffMetrics[bestStaffId].efficiency_score) {
            bestStaffId = id;
        }
        if (staffMetrics[id].efficiency_score < staffMetrics[worstStaffId].efficiency_score) {
            worstStaffId = id;
        }
    });
    
    // 使用3西格玛原则评估异常表现
    const upperThreshold = avgScore + 3 * stdDev;
    const lowerThreshold = avgScore - 3 * stdDev;
    
    // 找出表现异常的员工
    const outperformingStaff = staffIds.filter(id => staffMetrics[id].efficiency_score > upperThreshold);
    const underperformingStaff = staffIds.filter(id => staffMetrics[id].efficiency_score < lowerThreshold);
    
    // 根据3西格玛规则分类员工表现
    const excellentStaff = staffIds.filter(id => 
        staffMetrics[id].efficiency_score > avgScore + stdDev && 
        staffMetrics[id].efficiency_score <= upperThreshold);
    
    const goodStaff = staffIds.filter(id => 
        staffMetrics[id].efficiency_score > avgScore && 
        staffMetrics[id].efficiency_score <= avgScore + stdDev);
    
    const averageStaff = staffIds.filter(id => 
        staffMetrics[id].efficiency_score >= avgScore - stdDev && 
        staffMetrics[id].efficiency_score <= avgScore);
    
    const belowAverageStaff = staffIds.filter(id => 
        staffMetrics[id].efficiency_score >= lowerThreshold && 
        staffMetrics[id].efficiency_score < avgScore - stdDev);
    
    // 生成HTML报告
    let html = `
        <div class="mb-3">
            <p><strong>团队平均效能评分:</strong> ${avgScore.toFixed(2)}</p>
            <p><strong>团队效能标准差:</strong> ${stdDev.toFixed(2)}</p>
        </div>
        <div class="mb-3">
            <p><strong>表现最佳员工:</strong> ${bestStaffId} (${staffMetrics[bestStaffId].efficiency_score.toFixed(2)}分)</p>
            <p><strong>表现最差员工:</strong> ${worstStaffId} (${staffMetrics[worstStaffId].efficiency_score.toFixed(2)}分)</p>
        </div>
        <div class="mb-3">
            <h6>员工表现分布:</h6>
            <ul class="list-group">
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    优秀 (>${(avgScore + stdDev).toFixed(2)})
                    <span class="badge bg-success rounded-pill">${excellentStaff.length}</span>
                </li>
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    良好 (>${avgScore.toFixed(2)})
                    <span class="badge bg-primary rounded-pill">${goodStaff.length}</span>
                </li>
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    一般 (${(avgScore - stdDev).toFixed(2)}~${avgScore.toFixed(2)})
                    <span class="badge bg-info rounded-pill">${averageStaff.length}</span>
                </li>
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    需改进 (<${(avgScore - stdDev).toFixed(2)})
                    <span class="badge bg-warning rounded-pill">${belowAverageStaff.length}</span>
                </li>
            </ul>
        </div>
    `;
    
    // 异常表现报告
    if (outperformingStaff.length > 0 || underperformingStaff.length > 0) {
        html += '<div class="mb-3"><h6>异常表现 (超出3西格玛范围):</h6><ul>';
        
        outperformingStaff.forEach(id => {
            html += `<li class="text-success">员工 ${id}: 表现极其优秀 (${staffMetrics[id].efficiency_score.toFixed(2)}分)</li>`;
        });
        
        underperformingStaff.forEach(id => {
            html += `<li class="text-danger">员工 ${id}: 表现极其不佳 (${staffMetrics[id].efficiency_score.toFixed(2)}分)</li>`;
        });
        
        html += '</ul></div>';
    }
    
    document.getElementById('performanceAnalysis').innerHTML = html;
}

// 新增：生成预警与预测报告
function generateWarningPrediction() {
    const staffMetrics = staffData.staff_metrics || {};
    const staffIds = Object.keys(staffMetrics);
    
    if (staffIds.length === 0) {
        document.getElementById('warningPrediction').innerHTML = '<p class="text-muted">暂无数据</p>';
        return;
    }
    
    // 提取关键指标
    const efficiencyScores = staffIds.map(id => staffMetrics[id].efficiency_score);
    const skillLevels = staffIds.map(id => staffMetrics[id].skill_level);
    const successRates = staffIds.map(id => staffMetrics[id].success_rate);
    const opDurations = staffIds.map(id => staffMetrics[id].avg_operation_duration);
    
    // 计算平均值和标准差
    const avgEfficiency = calculateAverage(efficiencyScores);
    const stdDevEfficiency = calculateStandardDeviation(efficiencyScores, avgEfficiency);
    
    const avgSkill = calculateAverage(skillLevels);
    const stdDevSkill = calculateStandardDeviation(skillLevels, avgSkill);
    
    const avgSuccess = calculateAverage(successRates);
    const stdDevSuccess = calculateStandardDeviation(successRates, avgSuccess);
    
    const avgDuration = calculateAverage(opDurations);
    const stdDevDuration = calculateStandardDeviation(opDurations, avgDuration);
    
    // 基于3西格玛原则进行预警
    const needsTrainingStaff = staffIds.filter(id => 
        staffMetrics[id].skill_level < avgSkill - 2 * stdDevSkill || 
        staffMetrics[id].success_rate < avgSuccess - 2 * stdDevSuccess
    );
    
    const needsReviewStaff = staffIds.filter(id => 
        staffMetrics[id].avg_operation_duration > avgDuration + 2 * stdDevDuration
    );
    
    // 生成预警HTML
    let html = '<div class="mb-3"><h6>效能预警:</h6>';
    
    if (needsTrainingStaff.length === 0 && needsReviewStaff.length === 0) {
        html += '<p class="text-success">当前无需预警的员工</p>';
    } else {
        html += '<ul class="list-group">';
        
        needsTrainingStaff.forEach(id => {
            html += `
                <li class="list-group-item list-group-item-warning">
                    <div><strong>员工 ${id} 需要培训</strong></div>
                    <div>熟练度: ${staffMetrics[id].skill_level.toFixed(2)}% (团队平均: ${avgSkill.toFixed(2)}%)</div>
                    <div>成功率: ${staffMetrics[id].success_rate.toFixed(2)}% (团队平均: ${avgSuccess.toFixed(2)}%)</div>
                </li>
            `;
        });
        
        needsReviewStaff.forEach(id => {
            html += `
                <li class="list-group-item list-group-item-danger">
                    <div><strong>员工 ${id} 操作时长异常</strong></div>
                    <div>平均操作时长: ${staffMetrics[id].avg_operation_duration.toFixed(2)}小时 (团队平均: ${avgDuration.toFixed(2)}小时)</div>
                </li>
            `;
        });
        
        html += '</ul>';
    }
    
    html += '</div>';
    
    // 生成预测HTML
    html += '<div class="mb-3"><h6>效能预测:</h6>';
    
    // 基于当前数据进行简单预测
    const highPotentialStaff = staffIds.filter(id => 
        staffMetrics[id].skill_level > avgSkill && 
        staffMetrics[id].success_rate > avgSuccess &&
        staffMetrics[id].efficiency_score < avgEfficiency // 潜力员工：技能和成功率高但效能分还不是最高
    );
    
    const atRiskStaff = staffIds.filter(id => 
        (staffMetrics[id].skill_level < avgSkill && staffMetrics[id].skill_level > avgSkill - stdDevSkill) ||
        (staffMetrics[id].success_rate < avgSuccess && staffMetrics[id].success_rate > avgSuccess - stdDevSkill)
    );
    
    html += '<ul class="list-group">';
    
    if (highPotentialStaff.length > 0) {
        html += '<li class="list-group-item list-group-item-success">';
        html += '<div><strong>具有提升潜力的员工:</strong></div>';
        html += '<div>' + highPotentialStaff.join(', ') + '</div>';
        html += '<div><small>这些员工具备较高技能和成功率，通过适当指导可显著提升整体效能</small></div>';
        html += '</li>';
    }
    
    if (atRiskStaff.length > 0) {
        html += '<li class="list-group-item list-group-item-warning">';
        html += '<div><strong>需关注的员工:</strong></div>';
        html += '<div>' + atRiskStaff.join(', ') + '</div>';
        html += '<div><small>这些员工的表现接近团队平均水平下限，如不干预可能降至更低水平</small></div>';
        html += '</li>';
    }
    
    // 团队整体预测
    const teamTrend = avgEfficiency > 80 ? "良好" : (avgEfficiency > 70 ? "稳定" : "需提升");
    const teamVariation = stdDevEfficiency > 10 ? "较大" : "较小";
    
    html += `
        <li class="list-group-item list-group-item-info">
            <div><strong>团队效能趋势:</strong> ${teamTrend}</div>
            <div><strong>团队效能波动:</strong> ${teamVariation}</div>
            <div><small>基于当前数据分析的团队整体状况和发展趋势</small></div>
        </li>
    `;
    
    html += '</ul></div>';
    
    document.getElementById('warningPrediction').innerHTML = html;
}

// 新增：更新西格玛分布图
function updateSigmaDistributionChart() {
    const staffMetrics = staffData.staff_metrics || {};
    const staffIds = Object.keys(staffMetrics);
    
    if (staffIds.length === 0) return;
    
    // 提取效能评分
    const efficiencyScores = staffIds.map(id => staffMetrics[id].efficiency_score);
    const avgScore = calculateAverage(efficiencyScores);
    const stdDev = calculateStandardDeviation(efficiencyScores, avgScore);
    
    // 计算3西格玛区间
    const sigma1Plus = avgScore + stdDev;
    const sigma2Plus = avgScore + 2 * stdDev;
    const sigma3Plus = avgScore + 3 * stdDev;
    
    const sigma1Minus = avgScore - stdDev;
    const sigma2Minus = avgScore - 2 * stdDev;
    const sigma3Minus = avgScore - 3 * stdDev;
    
    // 统计各区间人数
    const sigma3PlusCount = staffIds.filter(id => staffMetrics[id].efficiency_score > sigma3Plus).length;
    const sigma2PlusCount = staffIds.filter(id => staffMetrics[id].efficiency_score > sigma2Plus && staffMetrics[id].efficiency_score <= sigma3Plus).length;
    const sigma1PlusCount = staffIds.filter(id => staffMetrics[id].efficiency_score > sigma1Plus && staffMetrics[id].efficiency_score <= sigma2Plus).length;
    const avgCount = staffIds.filter(id => staffMetrics[id].efficiency_score > sigma1Minus && staffMetrics[id].efficiency_score <= sigma1Plus).length;
    const sigma1MinusCount = staffIds.filter(id => staffMetrics[id].efficiency_score > sigma2Minus && staffMetrics[id].efficiency_score <= sigma1Minus).length;
    const sigma2MinusCount = staffIds.filter(id => staffMetrics[id].efficiency_score > sigma3Minus && staffMetrics[id].efficiency_score <= sigma2Minus).length;
    const sigma3MinusCount = staffIds.filter(id => staffMetrics[id].efficiency_score <= sigma3Minus).length;
    
    if (sigmaDistributionChart) sigmaDistributionChart.destroy();
    
    const ctx = document.getElementById('sigmaDistributionChart').getContext('2d');
    sigmaDistributionChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['< -3σ', '-3σ ~ -2σ', '-2σ ~ -1σ', '-1σ ~ +1σ', '+1σ ~ +2σ', '+2σ ~ +3σ', '> +3σ'],
            datasets: [{
                label: '员工数量',
                data: [sigma3MinusCount, sigma2MinusCount, sigma1MinusCount, avgCount, sigma1PlusCount, sigma2PlusCount, sigma3PlusCount],
                backgroundColor: [
                    'rgba(220, 53, 69, 0.8)',  // 红色 (< -3σ)
                    'rgba(253, 126, 20, 0.8)', // 橙色 (-3σ ~ -2σ)
                    'rgba(255, 193, 7, 0.8)',  // 黄色 (-2σ ~ -1σ)
                    'rgba(23, 162, 184, 0.8)', // 青色 (-1σ ~ +1σ)
                    'rgba(40, 167, 69, 0.8)',  // 绿色 (+1σ ~ +2σ)
                    'rgba(0, 123, 255, 0.8)',  // 蓝色 (+2σ ~ +3σ)
                    'rgba(102, 16, 242, 0.8)'  // 紫色 (> +3σ)
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: '员工数量'
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: '效能评分分布区间'
                    }
                }
            },
            plugins: {
                title: {
                    display: true,
                    text: `员工效能3西格玛分布 (μ=${avgScore.toFixed(2)}, σ=${stdDev.toFixed(2)})`
                },
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        afterLabel: function(context) {
                            const index = context.dataIndex;
                            const ranges = [
                                `< ${sigma3Minus.toFixed(2)}`,
                                `${sigma3Minus.toFixed(2)} ~ ${sigma2Minus.toFixed(2)}`,
                                `${sigma2Minus.toFixed(2)} ~ ${sigma1Minus.toFixed(2)}`,
                                `${sigma1Minus.toFixed(2)} ~ ${sigma1Plus.toFixed(2)}`,
                                `${sigma1Plus.toFixed(2)} ~ ${sigma2Plus.toFixed(2)}`,
                                `${sigma2Plus.toFixed(2)} ~ ${sigma3Plus.toFixed(2)}`,
                                `> ${sigma3Plus.toFixed(2)}`
                            ];
                            return `分数范围: ${ranges[index]}`;
                        }
                    }
                }
            }
        }
    });
}
</script>
{% endblock %} 